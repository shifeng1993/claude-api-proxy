# Claude API 代理服务 - 业务文档

## 1. 项目概述

### 1.1 项目简介
Claude API 代理服务是一个轻量级的 Node.js 中间代理服务，用于将 Claude AI API 格式的请求转换为 OpenAI 兼容格式，从而支持使用非 Anthropic 官方的大语言模型提供商（如 DeepSeek、OpenAI 等）。

### 1.2 核心价值
- **统一接口**: 允许 Claude AI 应用使用标准的 OpenAI 兼容 API
- **零依赖**: 仅使用 Node.js 原生模块，无需安装外部依赖
- **离线部署**: 适合私有部署，不依赖外部网络服务
- **模型映射**: 支持 Claude 模型到 OpenAI 模型的自动映射
- **简化架构**: 采用 Transformer 设计模式，代码结构清晰，易于维护和扩展

### 1.3 技术栈
- **运行环境**: Node.js >= 18.0.0
- **开发语言**: JavaScript (ES Modules)
- **HTTP 服务**: Node.js 原生 http/https 模块
- **进程管理**: PM2
- **架构模式**: 基于 claude-code-router 的 Transformer 架构设计

## 2. 系统架构

### 2.1 整体架构图

```
┌─────────────┐      ┌──────────────────┐      ┌────────────────┐
│   Claude    │─────▶│ Claude API       │─────▶│  OpenAI 兼容   │
│   客户端     │      │ Proxy 服务        │      │  后端 API      │
└─────────────┘      └──────────────────┘      └────────────────┘
```

### 2.2 架构设计

本项目采用基于 claude-code-router 的 Transformer 架构设计，相比传统的 Provider/Converter 分离架构具有以下优势：

1. **简化架构**: 将请求代理和格式转换合并到统一的 Transformer 组件中
2. **统一接口**: 所有 Transformer 实现相同的接口，便于管理和扩展
3. **代码复用**: 共享 HTTP 客户端、工具函数和流处理逻辑
4. **配置灵活**: 通过 URL 路径参数和环境变量灵活配置

#### Transformer 核心接口
- `transformRequestOut()`: 将 Claude 格式请求转换为目标 API 格式
- `transformResponseIn()`: 将目标 API 响应转换为 Claude 格式
- `handleStreamResponse()`: 处理流式响应（可选）
- `isStreamResponse()`: 判断是否为流式响应（可选）
- `name`: Transformer 名称标识
- `endPoint`: 目标 API 端点路径

### 2.4 目录结构

```
claude-api-proxy/
├── src/
│   ├── index.js                      # 应用入口
│   ├── server.js                     # HTTP 服务器核心
│   ├── router.js                     # 路由解析
│   ├── transformer/                  # Transformer 架构层
│   │   ├── index.js                  # Transformer 注册和获取
│   │   └── claude-to-openai.js       # Claude ↔ OpenAI 转换器（含 SSE 处理）
│   ├── services/
│   │   └── transformer.js            # Transformer 服务管理
│   └── utils/                        # 工具函数
│       ├── helpers.js                # 通用辅助函数
│       ├── http-client.js            # HTTP 客户端
│       ├── logger.js                 # 日志工具
│       └── converter.js              # 格式转换工具
├── ecosystem.config.cjs              # PM2 配置文件
├── package.json                      # 项目配置
└── README.md                         # 项目说明
```

### 2.5 模块职责

| 模块 | 文件 | 职责 |
|------|------|------|
| 应用入口 | index.js | 配置加载、服务启动、信号处理 |
| HTTP 服务器 | server.js | HTTP 请求/响应处理、错误处理 |
| 路由解析 | router.js | URL 路径解析、API Key 提取 |
| Transformer | transformer/ | Claude ↔ OpenAI 格式转换和请求代理 |
| Transformer 服务 | services/transformer.js | Transformer 注册和管理 |
| 转换工具 | utils/converter.js | Claude/OpenAI/统一格式互转、工具调用转换 |
| HTTP 客户端 | utils/http-client.js | 上游请求、压缩处理 |
| 辅助函数 | utils/helpers.js | JSON Schema 清理、URL 构建 |
| 日志器 | utils/logger.js | 异步日志记录 |

## 3. 核心业务流程

### 3.1 请求处理流程

```
用户请求 → 路由解析 → Transformer 选择 → 请求转换 → 上游请求
    ↓
响应处理 ← 响应转换 ← 响应接收 ← 上游响应
```

#### 详细流程：

1. **启动阶段** (index.js)
   - 提取环境变量配置
   - 启动 HTTP 服务器监听指定端口

2. **请求接收** (server.js)
   - 接收 HTTP 请求
   - 验证请求方法（仅允许 POST）
   - 路由分发到健康检查或代理请求

3. **路由解析** (router.js)
   - 解析 URL 路径: `/{type}/{provider_url}/v1/messages`
   - 提取参数: type (openai)、baseUrl、apiKey
   - 从请求头提取 API Key (x-api-key 或 authorization)

4. **Transformer 选择** (transformer/index.js)
   - 根据 type 参数选择对应的 Transformer 实现
   - 当前支持: ClaudeToOpenAITransformer (处理 OpenAI 兼容 API)

5. **请求转换** (transformer/claude-to-openai.js)
   - Claude 请求格式 → OpenAI 请求格式
   - 模型名称映射 (haiku/sonnet/opus → 具体模型)
   - 消息格式转换（包括工具调用）
   - JSON Schema 清理

6. **上游请求** (server.js)
   - 构建完整的上游 API URL
   - 发送 POST 请求到上游 API
   - 处理响应（包括压缩数据）

7. **响应处理** (server.js)
   - 判断响应类型（流式/非流式）
   - 调用对应的 Transformer 处理方法

8. **响应转换** (transformer/claude-to-openai.js)
   - OpenAI 响应格式 → Claude 响应格式
   - 支持流式 SSE 事件转换
   - 处理工具调用和特殊标签

### 3.2 模型映射逻辑

系统支持两种模型映射方式：

#### 方式一: 环境变量映射
```javascript
// 通过 ANTHROPIC_DEFAULT_*_MODEL 环境变量配置
ANTHROPIC_DEFAULT_HAIKU_MODEL = "deepseek-chat"
ANTHROPIC_DEFAULT_SONNET_MODEL = "deepseek-chat"
ANTHROPIC_DEFAULT_OPUS_MODEL = "deepseek-chat"
```

#### 方式二: 自定义 JSON 映射
```javascript
// 通过 OPENAI_MODEL_MAP 环境变量配置
OPENAI_MODEL_MAP = {
  "claude-3-haiku-20240307": "deepseek-chat",
  "claude-3-sonnet-20240229": "deepseek-chat",
  "custom-model": "other-model"
}
```

### 3.3 流式响应处理

流式响应采用 SSE (Server-Sent Events) 协议：

#### 3.3.1 流式响应架构

```
上游 SSE 数据 → SSE 行解析 → ClaudeStreamState 状态管理 → Claude SSE 输出
```

#### 3.3.2 上游 SSE 线程解析
- 按 `\n` 分割 SSE 数据行
- 解析 `data:` 前缀后的 JSON
- 检测 `[DONE]` 标记表示流结束

#### 3.3.3 ClaudeStreamState 状态管理

`ClaudeStreamState` 类负责管理流式响应的完整状态：

| 状态属性 | 说明 |
|---------|------|
| messageStarted / messageEnded | 消息开始/结束标记 |
| blockIndex | 内容块索引计数器 |
| thinkingIndex / thinkingOpen | 思考内容块索引和状态 |
| textIndex / textOpen | 文本块索引和状态 |
| _textBuffer | 文本内容缓冲区 |
| toolStates | 工具调用状态 Map（支持并行） |
| finalStopReason | 最终停止原因 |

#### 3.3.4 文本缓冲机制

为解决文本重复输出问题，采用缓冲机制：
1. 持续累积 `delta.content` 到 `partialTextBuffer`
2. 仅在 `finish_reason` 到达时才输出完整文本
3. 确保每个文本块只输出一次

#### 3.3.5 OpenAI → Claude Event 映射

| OpenAI 事件 | Claude 事件序列 |
|------------|-----------------|
| delta.content (非推理) | content_block_start + content_block_delta (text) + content_block_stop |
| delta.reasoning_content / delta.thinking.content | content_block_start + content_block_delta (thinking) + content_block_delta (signature) + content_block_stop |
| delta.tool_calls (function.name) | content_block_start (tool_use) |
| delta.tool_calls (function.arguments) | content_block_delta (input_json_delta) + content_block_stop |
| finish_reason = 'tool_calls' | message_stop (stop_reason: 'tool_use') |
| finish_reason = 'length' | message_stop (stop_reason: 'max_tokens') |
| finish_reason = other | message_stop (stop_reason: 'end_turn') |

#### 3.3.6 消息输出顺序保证

```
message_start
├─ content_block_start (thinking)  [可选，可多段]
├─ content_block_delta (thinking_delta)
├─ content_block_delta (signature_delta)
├─ content_block_stop
├─ content_block_start (tool_use)  [可选，支持并行]
├─ content_block_delta (input_json_delta)
├─ content_block_stop
├─ content_block_start (text)      [可选]
├─ content_block_delta (text_delta)
├─ content_block_stop
├─ message_delta
└─ message_stop                    [仅输出一次]
```

#### 3.3.7 错误处理

流式响应错误时会：
1. 自动关闭所有打开的内容块（thinking、tool_use、text）
2. 输出错误文本消息
3. 设置 stop_reason 为 'error'
4. 正常输出 message_stop

## 4. API 接口说明

### 4.1 请求 URL 格式

```
POST /{type}/{provider_url}/v1/messages
```

**参数说明:**
- `type`: Transformer 类型，当前支持 `openai`（对应 ClaudeToOpenAITransformer）
- `provider_url`: 目标 API 的基础 URL（支持 http/https 协议）

**示例:**
```
POST /openai/https://api.deepseek.com/v1/messages
```

### 4.2 请求头

| 头部名称 | 说明 | 必填 |
|---------|------|------|
| x-api-key | 目标 API 的认证密钥 | 是（二选一）|
| authorization | Authorization 格式的认证密钥 | 是（二选一）|
| content-type | 请求内容类型 | 是 |

### 4.3 请求体格式

Claude API 格式：
```json
{
  "model": "claude-3-sonnet-20240229",
  "messages": [
    {
      "role": "user",
      "content": "Hello, world!"
    }
  ],
  "max_tokens": 1000,
  "stream": true,
  "temperature": 0.7,
  "tools": [...]
}
```

### 4.4 响应体格式

非流式响应：
```json
{
  "id": "msg_xxx",
  "type": "message",
  "role": "assistant",
  "content": [
    {
      "type": "text",
      "text": "Hello! How can I help you?"
    }
  ],
  "stop_reason": "end_turn",
  "usage": {
    "input_tokens": 10,
    "output_tokens": 20
  }
}
```

流式响应 (SSE):
```
event: message_start
data: {"type":"message_start","message":{"id":"msg_xxx","type":"message","role":"assistant","content":[]}}

event: content_block_start
data: {"type":"content_block_start","index":0,"content_block":{"type":"text","text":""}}

event: content_block_delta
data: {"type":"content_block_delta","index":0,"delta":{"type":"text_delta","text":"Hello"}}

event: content_block_stop
data: {"type":"content_block_stop","index":0}

event: message_stop
data: {"type":"message_stop"}
```

## 5. 配置说明

### 5.1 环境变量

| 变量名 | 说明 | 默认值 |
|-------|------|--------|
| PORT | 服务监听端口 | 3080 |
| HOST | 服务绑定地址 | 0.0.0.0 |
| ANTHROPIC_AUTH_TOKEN | Anthropic 认证令牌 | - |
| ANTHROPIC_BASE_URL | API 基础 URL | - |
| ANTHROPIC_CUSTOM_HEADERS | 自定义请求头 | - |
| ANTHROPIC_DEFAULT_HAIKU_MODEL | Haiku 模型映射 | - |
| ANTHROPIC_DEFAULT_SONNET_MODEL | Sonnet 模型映射 | - |
| ANTHROPIC_DEFAULT_OPUS_MODEL | Opus 模型映射 | - |
| OPENAI_MODEL_MAP | 自定义模型映射 JSON | - |

### 5.2 配置文件示例

~/.claude/settings.json:
```json
{
  "env": {
    "ANTHROPIC_AUTH_TOKEN": "your-token",
    "ANTHROPIC_BASE_URL": "http://127.0.0.1:3080/openai/https://api.deepseek.com",
    "ANTHROPIC_CUSTOM_HEADERS": "x-api-key: your-api-key",
    "ANTHROPIC_DEFAULT_HAIKU_MODEL": "deepseek-chat",
    "ANTHROPIC_DEFAULT_SONNET_MODEL": "deepseek-chat",
    "ANTHROPIC_DEFAULT_OPUS_MODEL": "deepseek-chat",
    "API_TIMEOUT_MS": "60000",
    "CLAUDE_CODE_DISABLE_NONESSENTIAL_TRAFFIC": "1"
  },
  "model": "opus"
}
```

## 6. 部署指南

### 6.1 本地启动

```bash
# 安装依赖
npm install

# 启动服务
npm start

# 开发模式（文件监听）
npm run dev
```

### 6.2 PM2 部署

```bash
# 启动服务
pm2 start ./ecosystem.config.cjs

# 保存状态
pm2 save

# 设置开机自启
pm2 startup

# 查看状态
pm2 list

# 查看日志
pm2 logs ClaudeApiProxy

# 停止服务
pm2 stop 0

# 删除服务
pm2 delete 0
```

### 6.3 健康检查

服务启动后，访问以下端点检查状态：

```bash
curl http://localhost:3080/health
```

响应:
```json
{
  "status": "ok",
  "timestamp": "2024-01-23T09:00:00.000Z"
}
```

## 7. 错误处理

### 7.1 常见错误码

| HTTP 状态码 | 错误消息 | 说明 |
|------------|---------|------|
| 400 | Invalid path format | 请求路径格式错误 |
| 401 | Missing x-api-key or authorization header | 缺少认证信息 |
| 404 | Path must end with /v1/messages | 路径格式不正确 |
| 405 | Method not allowed | 不允许的 HTTP 方法 |
| 500 | Internal server error | 服务器内部错误 |

### 7.2 错误日志

错误信息会输出到控制台，格式如下：

```
[module] 错误信息: 详细内容
```

示例:
```
[router] 解析路径: /openai/https://api.deepseek.com/v1/messages
[router] 路径分段: ["openai","https:","api.deepseek.com","v1","messages"]
[router] 解析结果: type="openai", baseUrl="https://api.deepseek.com"
```

## 8. 特性说明

### 8.1 模型名称映射

系统自动识别 Claude 模型名称关键词：
- `haiku` → 映射到 ANTHROPIC_DEFAULT_HAIKU_MODEL
- `sonnet` → 映射到 ANTHROPIC_DEFAULT_SONNET_MODEL
- `opus` → 映射到 ANTHROPIC_DEFAULT_OPUS_MODEL

### 8.2 工具调用支持

支持将 Claude 工具调用格式转换为 OpenAI Function Calling 格式：

**Claude 格式:**
```json
{
  "type": "tool_use",
  "id": "toolu_xxx",
  "name": "function_name",
  "input": {"param": "value"}
}
```

**OpenAI 格式:**
```json
{
  "type": "function",
  "function": {
    "name": "function_name",
    "arguments": "{\"param\":\"value\"}"
  }
}
```

### 8.3 JSON Schema 清理

自动清理 OpenAI 不兼容的 JSON Schema 属性：
- `$schema`
- `additionalProperties`
- `title`
- `examples`
- `format` (针对 string 类型)

### 8.4 响应压缩处理

自动识别和处理上游响应的压缩数据：
- gzip
- deflate
- br

## 9. 限制和注意事项

1. **OpenAI API 限制**: max_tokens 最大值为 8192，超过时会自动修正
2. **协议支持**: 当前仅支持 HTTP/HTTPS 协议
3. **Transformer 类型**: 当前仅支持 OpenAI 兼容的 API (通过 ClaudeToOpenAITransformer)
4. **并发处理**: 使用 Node.js 原生事件循环，无额外并发限制
5. **超时设置**: 需要通过上游 API 的超时设置控制

## 10. 扩展指南

### 10.1 添加新的 Transformer

基于 claude-code-router 的 Transformer 架构，扩展新的转换器：

1. **创建新的 Transformer 类**
   - 在 `src/transformer/` 下创建新的 transformer 文件
   - 继承或实现统一的 Transformer 接口

2. **实现核心方法**（参考 ClaudeToOpenAITransformer）
   - `transformRequestOut(claudeRequest)`: Claude → 目标格式转换
   - `transformResponseIn(providerData)`: 目标格式 → Claude 转换
   - `handleStreamResponse(responseBody, res)`: 处理流式响应（可选）
   - `isStreamResponse(headers)`: 判断是否为流式响应（可选）

3. **Transformer 接口要求**
   - `name`: 转换器名称（必需）
   - `endPoint`: 上游 API 端点路径（可选）
   - 其他方法根据目标 API 特性实现

4. **注册 Transformer**
   - 在 `src/transformer/index.js` 中注册新 transformer
   - 添加到 transformers 映射表中

### 10.2 Transformer 架构优势

新的 Transformer 架构相比旧的 Provider/Converter 分离架构有以下优势：

1. **简化流程**: 将格式转换和请求代理统一到一个组件中
2. **代码复用**: 共享 HTTP 客户端和工具函数，减少重复代码
3. **易于扩展**: 添加新的 API 支持只需要实现一个 Transformer 类
4. **统一接口**: 所有 Transformer 遵循相同的接口规范
5. **配置灵活**: 支持通过环境变量和 URL 路径参数灵活配置

## 11. 性能建议

1. **启用压缩**: 上游 API 返回的压缩数据会自动解压
2. **流式响应**: 对于长内容建议使用流式响应
3. **连接复用**: Node.js 原生 http 客户端会自动复用连接
4. **日志控制**: 生产环境可减少 console.log 输出

## 12. 安全建议

1. **API Key 保护**: 使用环境变量存储敏感信息
2. **HTTPS 上游**: 建议使用 HTTPS 协议连接上游 API
3. **访问控制**: 在反向代理层实现 IP 白名单
4. **日志脱敏**: 敏感信息已在日志中自动脱敏

## 13. 监控和维护

### 13.1 监控指标

建议监控以下指标：
- 请求响应时间
- 请求成功率
- 错误率
- 流式响应延迟

### 13.2 日志分析

通过日志分析可以发现：
- 模型映射使用情况
- 工具调用频率
- 错误类型分布

## 14. 故障排��

### 问题: 请求返回 404

检查 URL 格式是否正确，应以 `/v1/messages` 结尾

### 问题: JSON 解析错误

检查上游 URL 是否正确，可能路径错误导致返回 HTML 页面

### 问题: 认证失败

检查 API Key 是否正确设置 in 请求头

### 问题: 流式响应中断

检查上游 API 是否正常返回流式数据